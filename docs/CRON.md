# 定时任务使用指南

## 概述

本项目使用 `robfig/cron/v3` 实现定时任务功能，支持秒级精度的 Cron 表达式。

## 目录结构

```
internal/cron/
└── cron.go          # 定时任务管理器
```

## Cron 表达式格式

```
秒 分 时 日 月 周
*  *  *  *  *  *
```

### 字段说明

| 字段 | 取值范围 | 特殊字符 |
|------|---------|---------|
| 秒 | 0-59 | * , - / |
| 分 | 0-59 | * , - / |
| 时 | 0-23 | * , - / |
| 日 | 1-31 | * , - / ? L W |
| 月 | 1-12 | * , - / |
| 周 | 0-7 | * , - / ? L # (0和7都代表周日) |

### 特殊字符说明

- `*` : 所有值
- `,` : 分隔列表 (如 `1,3,5`)
- `-` : 范围 (如 `1-5`)
- `/` : 间隔 (如 `*/5` 表示每5个单位)
- `?` : 不指定值 (仅用于日和周，互斥使用)

## 常用示例

```go
// 每5秒执行
"*/5 * * * * *"

// 每分钟执行
"0 * * * * *"

// 每小时执行
"0 0 * * * *"

// 每天凌晨2点执行
"0 0 2 * * *"

// 每周一凌晨2点执行
"0 0 2 * * 1"

// 每月1号凌晨执行
"0 0 0 1 * *"

// 工作时间每30分钟 (9点到17点)
"0 */30 9-17 * * *"

// 每天上午10点30分
"0 30 10 * * *"

// 周一到周五中午12点
"0 0 12 * * MON-FRI"

// 每周执行 (周日凌晨3点)
"0 0 3 * * 0"
```

## 如何添加定时任务

### 方式1: 在 cron.go 中注册

编辑 `internal/cron/cron.go` 的 `registerTasks` 方法:

```go
func (cm *CronManager) registerTasks() {
    // 添加你的任务
    cm.addJob("0 0 2 * * *", "我的任务", cm.myTask)
}

// 实现任务函数
func (cm *CronManager) myTask() {
    logger.Info("执行我的任务")
    // 你的业务逻辑
}
```

### 方式2: 在其他地方动态添加

```go
import "gosir/internal/cron"

// 添加自定义任务
err := cron.AddCustomJob("0 0 2 * * *", "数据备份", func() {
    // 备份逻辑
})
if err != nil {
    log.Fatal(err)
}
```

## 预置的示例任务

项目已包含以下示例任务:

1. **每5秒执行** - 用于测试和心跳检测
2. **每分钟执行** - 用于定期统计
3. **每小时执行** - 用于数据同步
4. **每天凌晨2点** - 用于数据归档
5. **每天上午10点30分** - 用于定时报告

## 注意事项

1. **任务耗时**: 避免在定时任务中执行耗时操作，考虑使用 goroutine
2. **错误处理**: 在任务中添加适当的错误处理和日志记录
3. **并发控制**: 如果任务可能重叠执行，需要加锁或使用互斥量
4. **优雅关闭**: 使用 `defer cron.Stop()` 确保服务关闭时任务正确停止

## 示例: 添加数据清理任务

```go
func (cm *CronManager) cleanupOldDataTask() {
    logger.Info("开始清理过期数据")
    
    // 清理逻辑
    err := cleanupOldData()
    if err != nil {
        logger.Error("清理数据失败", zap.Error(err))
        return
    }
    
    logger.Info("数据清理完成")
}

// 在 registerTasks 中注册
cm.addJob("0 0 3 * * *", "清理过期数据", cm.cleanupOldDataTask)
```

## 参考资源

- [robfig/cron GitHub](https://github.com/robfig/cron)
- [Cron 表达式在线测试](https://crontab.guru/)
